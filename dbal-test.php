<?php

declare(strict_types=1);

use Doctrine\DBAL\ExpandArrayParameters;
use Doctrine\DBAL\SQL\Parser;

require_once 'vendor/autoload.php';

// The following SQL causes:
// Fatal error: Uncaught AssertionError: assert($offset === strlen($sql)) in .../vendor/doctrine/dbal/src/SQL/Parser.php:105
//$sql = "SELECT p0_.holder_street AS holder_street_14, p0_.iban AS iban_16, p0_.locked AS locked_21, p0_.tasks AS tasks_34, p0_.updated_at AS updated_at_35, p0_.utilization AS utilization_36, p0_.id AS id_39, f1_.active AS active_40, f1_.application_self_assessment AS application_self_assessment_41, f1_.concretizations AS concretizations_42, f1_.concretization_self_assessment AS concretization_self_assessment_43, f1_.granted AS granted_44, f1_.grant_recommendation AS grant_recommendation_45, f1_.id AS id_46, f1_.preselection_order AS preselection_order_47, f1_.requested_funding AS requested_funding_48, f1_.state AS state_49, f1_.submission_data AS submission_data_50, f2_.budget AS budget_51, f2_.cost_types_required AS cost_types_required_52, f2_.criteria AS criteria_53, f2_.description AS description_54, f2_.direct_submission AS direct_submission_55, f2_.funded_cost_types AS funded_cost_types_56, f2_.funding_begin AS funding_begin_57, f2_.funding_duration AS funding_duration_58, f2_.funding_rate AS funding_rate_59, f2_.id AS id_60, f2_.imprint AS imprint_61, f2_.maximum_grant AS maximum_grant_62, f2_.minimum_grant AS minimum_grant_63, f2_.name AS name_64, f2_.region AS region_65, f2_.selection_process AS selection_process_66, f2_.slug AS slug_67, f2_.sponsor AS sponsor_68, f2_.state AS state_69, f2_.submission_begin AS submission_begin_70, f2_.submission_end AS submission_end_71, u3_.name AS name_72, u3_.original_name AS original_name_73, u3_.mime_type AS mime_type_74, u3_.size AS size_75, u3_.dimensions AS dimensions_76, u3_.created_at AS created_at_77, u3_.id AS id_78, c4_.id AS id_79, u5_.username AS username_80, u5_.password AS password_81, u5_.email AS email_82, u5_.roles AS roles_83, u5_.first_name AS first_name_84, u5_.last_name AS last_name_85, u5_.active AS active_86, u5_.validated AS validated_87, u5_.created_at AS created_at_88, u5_.deleted_at AS deleted_at_89, u5_.id AS id_90, p6_.bank_name AS bank_name_91, p6_.bic AS bic_92, p6_.challenges AS challenges_93, p6_.contact_email AS contact_email_94, p6_.contact_name AS contact_name_95, p6_.contact_phone AS contact_phone_96, p6_.created_at AS created_at_97, p6_.deleted_at AS deleted_at_98, p6_.delimitation AS delimitation_99, p6_.description AS description_100, p6_.goal AS goal_101, p6_.holder_address_info AS holder_address_info_102, p6_.holder_city AS holder_city_103, p6_.holder_name AS holder_name_104, p6_.holder_street AS holder_street_105, p6_.holder_zip_code AS holder_zip_code_106, p6_.iban AS iban_107, p6_.impact AS impact_108, p6_.implementation_begin AS implementation_begin_109, p6_.implementation_time AS implementation_time_110, p6_.implementation_state AS implementation_state_111, p6_.locked AS locked_112, p6_.member_count AS member_count_113, p6_.name AS name_114, p6_.outcome AS outcome_115, p6_.plan_self_assessment AS plan_self_assessment_116, p6_.profile_self_assessment AS profile_self_assessment_117, p6_.progress AS progress_118, p6_.resource_requirements AS resource_requirements_119, p6_.results AS results_120, p6_.short_description AS short_description_121, p6_.slug AS slug_122, p6_.state AS state_123, p6_.target_groups AS target_groups_124, p6_.tasks AS tasks_125, p6_.updated_at AS updated_at_126, p6_.utilization AS utilization_127, p6_.vision AS vision_128, p6_.work_packages AS work_packages_129, p6_.id AS id_130, p7_.motivation AS motivation_131, p7_.role AS role_132, p7_.skills AS skills_133, u8_.name AS name_134, u8_.original_name AS original_name_135, u8_.mime_type AS mime_type_136, u8_.size AS size_137, u8_.dimensions AS dimensions_138, u8_.created_at AS created_at_139, u8_.id AS id_140, u9_.name AS name_141, u9_.original_name AS original_name_142, u9_.mime_type AS mime_type_143, u9_.size AS size_144, u9_.dimensions AS dimensions_145, u9_.created_at AS created_at_146, u9_.id AS id_147, p10_.criteria AS criteria_148, p10_.description AS description_149, p10_.goals AS goals_150, p10_.imprint AS imprint_151, p10_.name AS name_152, p10_.region AS region_153, p10_.slug AS slug_154, p10_.id AS id_155, p11_.bank_name AS bank_name_156, p11_.bic AS bic_157, p11_.challenges AS challenges_158, p11_.contact_email AS contact_email_159, p11_.contact_name AS contact_name_160, p11_.contact_phone AS contact_phone_161, p11_.created_at AS created_at_162, p11_.deleted_at AS deleted_at_163, p11_.delimitation AS delimitation_164, p11_.description AS description_165, p11_.goal AS goal_166, p11_.holder_address_info AS holder_address_info_167, p11_.holder_city AS holder_city_168, p11_.holder_name AS holder_name_169, p11_.holder_street AS holder_street_170, p11_.holder_zip_code AS holder_zip_code_171, p11_.iban AS iban_172, p11_.impact AS impact_173, p11_.implementation_begin AS implementation_begin_174, p11_.implementation_time AS implementation_time_175, p11_.implementation_state AS implementation_state_176, p11_.locked AS locked_177, p11_.member_count AS member_count_178, p11_.name AS name_179, p11_.outcome AS outcome_180, p11_.plan_self_assessment AS plan_self_assessment_181, p11_.profile_self_assessment AS profile_self_assessment_182, p11_.progress AS progress_183, p11_.resource_requirements AS resource_requirements_184, p11_.results AS results_185, p11_.short_description AS short_description_186, p11_.slug AS slug_187, p11_.state AS state_188, p11_.target_groups AS target_groups_189, p11_.tasks AS tasks_190, p11_.updated_at AS updated_at_191, p11_.utilization AS utilization_192, p11_.vision AS vision_193, p11_.work_packages AS work_packages_194, p11_.id AS id_195, u12_.username AS username_196, u12_.password AS password_197, u12_.email AS email_198, u12_.roles AS roles_199, u12_.first_name AS first_name_200, u12_.last_name AS last_name_201, u12_.active AS active_202, u12_.validated AS validated_203, u12_.created_at AS created_at_204, u12_.deleted_at AS deleted_at_205, u12_.id AS id_206, u13_.name AS name_207, u13_.original_name AS original_name_208, u13_.mime_type AS mime_type_209, u13_.size AS size_210, u13_.dimensions AS dimensions_211, u13_.created_at AS created_at_212, u13_.id AS id_213, p0_.created_by_id AS created_by_id_214, p0_.inspiration_id AS inspiration_id_215, p0_.pdf_file_id AS pdf_file_id_216, p0_.picture_id AS picture_id_217, p0_.process_id AS process_id_218, p0_.team_contact_id AS team_contact_id_219, p0_.visualization_id AS visualization_id_220, f1_.fund_id AS fund_id_221, f1_.pdf_file_id AS pdf_file_id_222, f1_.project_id AS project_id_223, f2_.logo_id AS logo_id_224, f2_.process_id AS process_id_225, u3_.type AS type_226, p6_.created_by_id AS created_by_id_227, p6_.inspiration_id AS inspiration_id_228, p6_.pdf_file_id AS pdf_file_id_229, p6_.picture_id AS picture_id_230, p6_.process_id AS process_id_231, p6_.team_contact_id AS team_contact_id_232, p6_.visualization_id AS visualization_id_233, p7_.project_id AS project_id_234, p7_.user_id AS user_id_235, u8_.type AS type_236, u9_.type AS type_237, p10_.logo_id AS logo_id_238, p11_.created_by_id AS created_by_id_239, p11_.inspiration_id AS inspiration_id_240, p11_.pdf_file_id AS pdf_file_id_241, p11_.picture_id AS picture_id_242, p11_.process_id AS process_id_243, p11_.team_contact_id AS team_contact_id_244, p11_.visualization_id AS visualization_id_245, u13_.type AS type_246 FROM project p0_ LEFT JOIN fund_application f1_ ON p0_.id = f1_.project_id LEFT JOIN fund f2_ ON f1_.fund_id = f2_.id LEFT JOIN uploaded_file u3_ ON f1_.pdf_file_id = u3_.id AND u3_.type IN ('project_pdf') LEFT JOIN project_category p14_ ON p0_.id = p14_.project_id LEFT JOIN category c4_ ON c4_.id = p14_.category_id LEFT JOIN users u5_ ON p0_.created_by_id = u5_.id LEFT JOIN project p6_ ON p0_.inspiration_id = p6_.id AND (p6_.deleted_at IS NULL) LEFT JOIN project_membership p7_ ON p0_.id = p7_.project_id LEFT JOIN uploaded_file u8_ ON p0_.pdf_file_id = u8_.id AND u8_.type IN ('project_pdf') LEFT JOIN uploaded_file u9_ ON p0_.picture_id = u9_.id AND u9_.type IN ('project_picture') INNER JOIN process p10_ ON p0_.process_id = p10_.id LEFT JOIN project p11_ ON p0_.id = p11_.inspiration_id AND (p11_.deleted_at IS NULL) LEFT JOIN users u12_ ON p0_.team_contact_id = u12_.id LEFT JOIN uploaded_file u13_ ON p0_.visualization_id = u13_.id AND u13_.type IN ('project_visualization') WHERE p0_.deleted_at IS NULL ORDER BY p0_.id ASC";

// This works, it is the same SQL as above, only the first selected property removed
// You can remove any other sufficiently long selected property instead to reduce the string length
// and it will fail also, but removing e.g. "p0_.iban AS iban_16" does not reduce the string
// enough to make preg_match() work:
//$sql = str_replace('p0_.holder_street AS holder_street_14, ', '', $sql);

// new demo query failing with applied #4916
$sql = "SELECT p0_.bank_name AS bank_name_0, p0_.bic AS bic_1, p0_.challenges AS challenges_2, p0_.contact_email AS contact_email_3, p0_.contact_name AS contact_name_4, p0_.contact_phone AS contact_phone_5, p0_.created_at AS created_at_6, p0_.deleted_at AS deleted_at_7, p0_.delimitation AS delimitation_8, p0_.description AS description_9, p0_.goal AS goal_10, p0_.holder_address_info AS holder_address_info_11, p0_.holder_city AS holder_city_12, p0_.holder_name AS holder_name_13, p0_.holder_street AS holder_street_14, p0_.holder_zip_code AS holder_zip_code_15, p0_.iban AS iban_16, p0_.impact AS impact_17, p0_.implementation_begin AS implementation_begin_18, p0_.implementation_time AS implementation_time_19, p0_.implementation_state AS implementation_state_20, p0_.locked AS locked_21, p0_.member_count AS member_count_22, p0_.name AS name_23, p0_.outcome AS outcome_24, p0_.plan_self_assessment AS plan_self_assessment_25, p0_.profile_self_assessment AS profile_self_assessment_26, p0_.progress AS progress_27, p0_.resource_requirements AS resource_requirements_28, p0_.results AS results_29, p0_.short_description AS short_description_30, p0_.slug AS slug_31, p0_.state AS state_32, p0_.target_groups AS target_groups_33, p0_.tasks AS tasks_34, p0_.updated_at AS updated_at_35, p0_.utilization AS utilization_36, p0_.vision AS vision_37, p0_.work_packages AS work_packages_38, p0_.id AS id_39, f1_.active AS active_40, f1_.application_self_assessment AS application_self_assessment_41, f1_.concretizations AS concretizations_42, f1_.concretization_self_assessment AS concretization_self_assessment_43, f1_.granted AS granted_44, f1_.grant_recommendation AS grant_recommendation_45, f1_.id AS id_46, f1_.preselection_order AS preselection_order_47, f1_.requested_funding AS requested_funding_48, f1_.state AS state_49, f1_.submission_data AS submission_data_50, f2_.budget AS budget_51, f2_.cost_types_required AS cost_types_required_52, f2_.criteria AS criteria_53, f2_.description AS description_54, f2_.direct_submission AS direct_submission_55, f2_.funded_cost_types AS funded_cost_types_56, f2_.funding_begin AS funding_begin_57, f2_.funding_duration AS funding_duration_58, f2_.funding_rate AS funding_rate_59, f2_.id AS id_60, f2_.imprint AS imprint_61, f2_.maximum_grant AS maximum_grant_62, f2_.minimum_grant AS minimum_grant_63, f2_.name AS name_64, f2_.region AS region_65, f2_.selection_process AS selection_process_66, f2_.slug AS slug_67, f2_.sponsor AS sponsor_68, f2_.state AS state_69, f2_.submission_begin AS submission_begin_70, f2_.submission_end AS submission_end_71, u3_.name AS name_72, u3_.original_name AS original_name_73, u3_.mime_type AS mime_type_74, u3_.size AS size_75, u3_.dimensions AS dimensions_76, u3_.created_at AS created_at_77, u3_.id AS id_78, c4_.id AS id_79, u5_.username AS username_80, u5_.password AS password_81, u5_.email AS email_82, u5_.roles AS roles_83, u5_.first_name AS first_name_84, u5_.last_name AS last_name_85, u5_.active AS active_86, u5_.validated AS validated_87, u5_.created_at AS created_at_88, u5_.deleted_at AS deleted_at_89, u5_.id AS id_90, p6_.bank_name AS bank_name_91, p6_.bic AS bic_92, p6_.challenges AS challenges_93, p6_.contact_email AS contact_email_94, p6_.contact_name AS contact_name_95, p6_.contact_phone AS contact_phone_96, p6_.created_at AS created_at_97, p6_.deleted_at AS deleted_at_98, p6_.delimitation AS delimitation_99, p6_.description AS description_100, p6_.goal AS goal_101, p6_.holder_address_info AS holder_address_info_102, p6_.holder_city AS holder_city_103, p6_.holder_name AS holder_name_104, p6_.holder_street AS holder_street_105, p6_.holder_zip_code AS holder_zip_code_106, p6_.iban AS iban_107, p6_.impact AS impact_108, p6_.implementation_begin AS implementation_begin_109, p6_.implementation_time AS implementation_time_110, p6_.implementation_state AS implementation_state_111, p6_.locked AS locked_112, p6_.member_count AS member_count_113, p6_.name AS name_114, p6_.outcome AS outcome_115, p6_.plan_self_assessment AS plan_self_assessment_116, p6_.profile_self_assessment AS profile_self_assessment_117, p6_.progress AS progress_118, p6_.resource_requirements AS resource_requirements_119, p6_.results AS results_120, p6_.short_description AS short_description_121, p6_.slug AS slug_122, p6_.state AS state_123, p6_.target_groups AS target_groups_124, p6_.tasks AS tasks_125, p6_.updated_at AS updated_at_126, p6_.utilization AS utilization_127, p6_.vision AS vision_128, p6_.work_packages AS work_packages_129, p6_.id AS id_130, p7_.motivation AS motivation_131, p7_.role AS role_132, p7_.skills AS skills_133, u8_.name AS name_134, u8_.original_name AS original_name_135, u8_.mime_type AS mime_type_136, u8_.size AS size_137, u8_.dimensions AS dimensions_138, u8_.created_at AS created_at_139, u8_.id AS id_140, u9_.name AS name_141, u9_.original_name AS original_name_142, u9_.mime_type AS mime_type_143, u9_.size AS size_144, u9_.dimensions AS dimensions_145, u9_.created_at AS created_at_146, u9_.id AS id_147, p10_.criteria AS criteria_148, p10_.description AS description_149, p10_.goals AS goals_150, p10_.imprint AS imprint_151, p10_.name AS name_152, p10_.region AS region_153, p10_.slug AS slug_154, p10_.id AS id_155, p11_.bank_name AS bank_name_156, p11_.bic AS bic_157, p11_.challenges AS challenges_158, p11_.contact_email AS contact_email_159, p11_.contact_name AS contact_name_160, p11_.contact_phone AS contact_phone_161, p11_.created_at AS created_at_162, p11_.deleted_at AS deleted_at_163, p11_.delimitation AS delimitation_164, p11_.description AS description_165, p11_.goal AS goal_166, p11_.holder_address_info AS holder_address_info_167, p11_.holder_city AS holder_city_168, p11_.holder_name AS holder_name_169, p11_.holder_street AS holder_street_170, p11_.holder_zip_code AS holder_zip_code_171, p11_.iban AS iban_172, p11_.impact AS impact_173, p11_.implementation_begin AS implementation_begin_174, p11_.implementation_time AS implementation_time_175, p11_.implementation_state AS implementation_state_176, p11_.locked AS locked_177, p11_.member_count AS member_count_178, p11_.name AS name_179, p11_.outcome AS outcome_180, p11_.plan_self_assessment AS plan_self_assessment_181, p11_.profile_self_assessment AS profile_self_assessment_182, p11_.progress AS progress_183, p11_.resource_requirements AS resource_requirements_184, p11_.results AS results_185, p11_.short_description AS short_description_186, p11_.slug AS slug_187, p11_.state AS state_188, p11_.target_groups AS target_groups_189, p11_.tasks AS tasks_190, p11_.updated_at AS updated_at_191, p11_.utilization AS utilization_192, p11_.vision AS vision_193, p11_.work_packages AS work_packages_194, p11_.id AS id_195, u12_.username AS username_196, u12_.password AS password_197, u12_.email AS email_198, u12_.roles AS roles_199, u12_.first_name AS first_name_200, u12_.last_name AS last_name_201, u12_.active AS active_202, u12_.validated AS validated_203, u12_.created_at AS created_at_204, u12_.deleted_at AS deleted_at_205, u12_.id AS id_206, u13_.name AS name_207, u13_.original_name AS original_name_208, u13_.mime_type AS mime_type_209, u13_.size AS size_210, u13_.dimensions AS dimensions_211, u13_.created_at AS created_at_212, u13_.id AS id_213, p0_.created_by_id AS created_by_id_214, p0_.inspiration_id AS inspiration_id_215, p0_.pdf_file_id AS pdf_file_id_216, p0_.picture_id AS picture_id_217, p0_.process_id AS process_id_218, p0_.team_contact_id AS team_contact_id_219, p0_.visualization_id AS visualization_id_220, f1_.fund_id AS fund_id_221, f1_.pdf_file_id AS pdf_file_id_222, f1_.project_id AS project_id_223, f2_.logo_id AS logo_id_224, f2_.process_id AS process_id_225, u3_.type AS type_226, p6_.created_by_id AS created_by_id_227, p6_.inspiration_id AS inspiration_id_228, p6_.pdf_file_id AS pdf_file_id_229, p6_.picture_id AS picture_id_230, p6_.process_id AS process_id_231, p6_.team_contact_id AS team_contact_id_232, p6_.visualization_id AS visualization_id_233, p7_.project_id AS project_id_234, p7_.user_id AS user_id_235, u8_.type AS type_236, u9_.type AS type_237, p10_.logo_id AS logo_id_238, p11_.created_by_id AS created_by_id_239, p11_.inspiration_id AS inspiration_id_240, p11_.pdf_file_id AS pdf_file_id_241, p11_.picture_id AS picture_id_242, p11_.process_id AS process_id_243, p11_.team_contact_id AS team_contact_id_244, p11_.visualization_id AS visualization_id_245, u13_.type AS type_246 FROM project p0_ LEFT JOIN fund_application f1_ ON p0_.id = f1_.project_id LEFT JOIN fund f2_ ON f1_.fund_id = f2_.id LEFT JOIN uploaded_file u3_ ON f1_.pdf_file_id = u3_.id AND u3_.type IN ('project_pdf') LEFT JOIN project_category p14_ ON p0_.id = p14_.project_id LEFT JOIN category c4_ ON c4_.id = p14_.category_id LEFT JOIN users u5_ ON p0_.created_by_id = u5_.id AND (u5_.deleted_at IS NULL AND u5_.validated = ?) LEFT JOIN project p6_ ON p0_.inspiration_id = p6_.id AND (p6_.deleted_at IS NULL) LEFT JOIN project_membership p7_ ON p0_.id = p7_.project_id LEFT JOIN uploaded_file u8_ ON p0_.pdf_file_id = u8_.id AND u8_.type IN ('project_pdf') LEFT JOIN uploaded_file u9_ ON p0_.picture_id = u9_.id AND u9_.type IN ('project_picture') INNER JOIN process p10_ ON p0_.process_id = p10_.id LEFT JOIN project p11_ ON p0_.id = p11_.inspiration_id AND (p11_.deleted_at IS NULL) LEFT JOIN users u12_ ON p0_.team_contact_id = u12_.id LEFT JOIN uploaded_file u13_ ON p0_.visualization_id = u13_.id AND u13_.type IN ('project_visualization') WHERE p0_.deleted_at IS NULL AND p0_.locked = ? AND p0_.id IN (?) ORDER BY p0_.id ASC";

var_dump(strlen($sql));

// setting $mySQLStringEscaping to TRUE also fails with the same assertion error,
// even with a shorter SQL string
$parser = new Parser(false);

$visitor = new ExpandArrayParameters([], []);

$parser->parse($sql, $visitor);